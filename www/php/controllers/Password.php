<?php

class PasswordController extends FwController {
    const route_default_action = '';
    public $base_url = '/Password';
    public $model_name = 'Users';

    public function __construct() {
        parent::__construct();

        #override layout
        $this->fw->page_layout = $this->fw->config->PAGE_LAYOUT_PUBLIC;
        throw new ApplicationException('Access Denied');
    }

    public function IndexAction() {
        if ($this->fw->isGetRequest()){
            #defaults
            $item=array();
        }else{
            $item = reqh('item');
        }

        $ps = array(
            'i'     => $item,
            'hide_sidebar'  => true,
        );

        return $ps;
    }

    public function SaveAction() {
        $item = reqh('item');
        $item['login']=trim($item['login']);

        try{
            $this->Validate(0, $item);
            $user = $this->model->oneByEmail($item['login']);

            #$this->fw->sendEmailTpl( $user['email'], 'email_pwd.txt', $user);

            fw::redirect($this->base_url.'/(Sent)');

        }catch( ApplicationException $ex ){
            $this->setFormError($ex->getMessage());
            $this->routeRedirect("Index");
        }
    }

    public function Validate($id, $item) {
        $result= $this->validateRequired($item, "login");

        if ($result){
            $user = $this->model->oneByEmail($item['login']);
            if (!count($user)) $this->setError('login', 'WRONG');
        }

        $this->validateCheckResult();
    }

}//end of class
